// ==============================
// TELEGRAM BOT - GITHUB UPLOADER
// ==============================

export default {
  async fetch(request, env, ctx) {
    
    // ========== áá‹ GET Request (Browser á€€á€”á€±á€–á€½á€„á€·á€ºá€€á€¼á€Šá€·á€ºá€œá€­á€¯á€·á€›á€¡á€±á€¬á€„á€º) ==========
    if (request.method === 'GET') {
      return new Response(`
âœ… Telegram Bot is running!

Environment Status:
- TELEGRAM_BOT_TOKEN: ${env.TELEGRAM_BOT_TOKEN ? 'âœ… á€•á€«á€á€šá€º' : 'âŒ á€™á€•á€«á€˜á€°á€¸'}
- GITHUB_TOKEN: ${env.GITHUB_TOKEN ? 'âœ… á€•á€«á€á€šá€º' : 'âŒ á€™á€•á€«á€˜á€°á€¸'}
- GITHUB_REPO: ${env.GITHUB_REPO || 'âŒ á€™á€•á€«á€˜á€°á€¸'}
- GITHUB_FILE_PATH: ${env.GITHUB_FILE_PATH || 'âŒ á€™á€•á€«á€˜á€°á€¸'}
- GITHUB_BRANCH: ${env.GITHUB_BRANCH || 'âŒ á€™á€•á€«á€˜á€°á€¸'}

Send evt.json file to your bot to update GitHub.
      `, { 
        status: 200,
        headers: { 'Content-Type': 'text/plain' }
      });
    }

    // ========== á‚á‹ POST Request (Telegram Webhook) ==========
    if (request.method === 'POST') {
      try {
        // Telegram á€†á€®á€€ Update á€€á€­á€¯á€šá€°á€™á€šá€º
        const update = await request.json();
        console.log('ğŸ“¥ Update received:', JSON.stringify(update));
        
        // Message á€”á€²á€· Chat ID á€›á€¾á€­á€™á€›á€¾á€­á€…á€…á€ºá€™á€šá€º
        const message = update.message;
        if (!message || !message.chat || !message.chat.id) {
          return new Response('No message', { status: 200 });
        }

        const chatId = message.chat.id;
        
        // ========== áƒá‹ á€–á€­á€¯á€„á€ºá€Ÿá€¯á€á€ºá€™á€Ÿá€¯á€á€ºá€…á€…á€ºá€™á€šá€º ==========
        if (!message.document) {
          // á€–á€­á€¯á€„á€ºá€™á€Ÿá€¯á€á€ºá€›á€„á€º á€œá€™á€ºá€¸á€Šá€½á€¾á€”á€ºá€…á€¬á€•á€¼á€”á€ºá€™á€šá€º
          await this.sendTelegramMessage(env.TELEGRAM_BOT_TOKEN, chatId, 
            'ğŸ“ á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á€•á€¼á€®á€¸ **evt.json** á€–á€­á€¯á€„á€ºá€€á€­á€¯ Document á€¡á€”á€±á€”á€²á€· á€•á€­á€¯á€·á€•á€±á€¸á€•á€«á‹');
          return new Response('OK', { status: 200 });
        }

        // ========== á„á‹ á€–á€­á€¯á€„á€ºá€¡á€™á€Šá€ºá€…á€…á€ºá€™á€šá€º ==========
        const fileName = message.document.file_name;
        if (fileName !== 'evt.json') {
          await this.sendTelegramMessage(env.TELEGRAM_BOT_TOKEN, chatId,
            `âš ï¸ á€–á€­á€¯á€„á€ºá€¡á€™á€Šá€º "${fileName}" á€™á€¾á€¬á€¸á€”á€±á€•á€«á€á€šá€ºá‹\n**evt.json** á€–á€­á€¯á€„á€ºá€€á€­á€¯á€•á€² á€•á€­á€¯á€·á€•á€±á€¸á€•á€«á‹`);
          return new Response('OK', { status: 200 });
        }

        // ========== á…á‹ á€–á€­á€¯á€„á€ºá€€á€­á€¯á€…á€á€„á€º Download á€œá€¯á€•á€ºá€™á€šá€º ==========
        await this.sendTelegramMessage(env.TELEGRAM_BOT_TOKEN, chatId, 
          'â³ á€–á€­á€¯á€„á€ºá€€á€­á€¯á€œá€€á€ºá€á€¶á€›á€›á€¾á€­á€•á€«á€•á€¼á€®á‹ GitHub á€•á€±á€«á€ºá€á€„á€ºá€”á€±á€•á€«á€á€šá€º...');
        
        const fileId = message.document.file_id;
        
        // á….á Telegram á€€á€”á€± File Info á€›á€šá€°á€™á€šá€º
        const fileInfo = await this.getTelegramFileInfo(env.TELEGRAM_BOT_TOKEN, fileId);
        
        // á….á‚ á€–á€­á€¯á€„á€ºá€€á€­á€¯ Download á€œá€¯á€•á€ºá€™á€šá€º
        const fileContent = await this.downloadTelegramFile(env.TELEGRAM_BOT_TOKEN, fileInfo.file_path);
        
        // ========== á†á‹ GitHub á€•á€±á€«á€º Upload á€œá€¯á€•á€ºá€™á€šá€º ==========
        const githubResult = await this.uploadToGitHub({
          token: env.GITHUB_TOKEN,
          repo: env.GITHUB_REPO,
          path: env.GITHUB_FILE_PATH,
          branch: env.GITHUB_BRANCH,
          content: fileContent,
          commitMessage: `Bot update: ${fileName}`
        });

        // ========== á‡á‹ á€›á€œá€’á€ºá€€á€­á€¯ Telegram á€™á€¾á€¬á€•á€¼á€”á€ºá€•á€­á€¯á€·á€™á€šá€º ==========
        if (githubResult.success) {
          await this.sendTelegramMessage(env.TELEGRAM_BOT_TOKEN, chatId,
            `âœ… **${fileName}** á€€á€­á€¯ GitHub á€•á€±á€«á€º á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€á€„á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹\n\nğŸ“ https://github.com/${env.GITHUB_REPO}/blob/${env.GITHUB_BRANCH}/${env.GITHUB_FILE_PATH}`);
        } else {
          await this.sendTelegramMessage(env.TELEGRAM_BOT_TOKEN, chatId,
            `âŒ GitHub á€á€„á€ºá€á€²á€·á€¡á€á€« á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€á€½á€¬á€¸á€•á€«á€á€šá€ºá‹\n\n**Error:** ${githubResult.error}`);
        }

        return new Response('OK', { status: 200 });

      } catch (error) {
        // ========== Error Handling ==========
        console.error('ğŸ”¥ Worker Error:', error);
        
        // Error á€€á€­á€¯ Telegram á€•á€¼á€”á€ºá€•á€­á€¯á€·á€–á€­á€¯á€·á€€á€¼á€­á€¯á€¸á€…á€¬á€¸á€™á€šá€º
        try {
          const update = await request.clone().json();
          const chatId = update?.message?.chat?.id;
          if (chatId) {
            await this.sendTelegramMessage(env.TELEGRAM_BOT_TOKEN, chatId,
              `âŒ **á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€á€½á€¬á€¸á€•á€«á€á€šá€º**\n\n${error.message || 'Unknown error'}`);
          }
        } catch (e) {
          // Telegram á€•á€¼á€”á€ºá€™á€•á€­á€¯á€·á€”á€­á€¯á€„á€ºá€›á€„á€º á€˜á€¬á€™á€¾á€™á€œá€¯á€•á€ºá€á€±á€¬á€·á€˜á€°á€¸
        }
        
        return new Response('Error', { status: 500 });
      }
    }

    // ========== áˆá‹ á€¡á€á€¼á€¬á€¸ Method á€á€½á€±á€¡á€á€½á€€á€º ==========
    return new Response('Method not allowed', { status: 405 });
  },

  // ===========================================
  // Helper Functions
  // ===========================================

  // Telegram Message á€•á€­á€¯á€·á€›á€”á€º
  async sendTelegramMessage(botToken, chatId, text) {
    const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        chat_id: chatId, 
        text: text,
        parse_mode: 'Markdown'
      })
    });
    
    if (!response.ok) {
      const error = await response.text();
      console.error('âŒ Telegram sendMessage error:', error);
    }
    
    return response;
  },

  // Telegram File Info á€›á€šá€°á€›á€”á€º
  async getTelegramFileInfo(botToken, fileId) {
    const url = `https://api.telegram.org/bot${botToken}/getFile?file_id=${fileId}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (!data.ok) {
      throw new Error(`Telegram API Error: ${data.description || 'Unknown error'}`);
    }
    
    return {
      file_path: data.result.file_path,
      file_size: data.result.file_size
    };
  },

  // Telegram File Download á€œá€¯á€•á€ºá€›á€”á€º
  async downloadTelegramFile(botToken, filePath) {
    const url = `https://api.telegram.org/file/bot${botToken}/${filePath}`;
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`Download failed: ${response.status}`);
    }
    
    return await response.text();
  },

  // GitHub Upload á€œá€¯á€•á€ºá€›á€”á€º
  async uploadToGitHub({ token, repo, path, branch, content, commitMessage }) {
    
    try {
      // áá‹ Base64 Encode
      const base64Content = btoa(unescape(encodeURIComponent(content)));
      
      // á‚á‹ á€œá€€á€ºá€›á€¾á€­ File á€›á€¾á€­á€™á€›á€¾á€­ á€…á€…á€ºá€†á€±á€¸á€•á€¼á€®á€¸ SHA á€›á€šá€°á€™á€šá€º
      const getUrl = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
      const getResponse = await fetch(getUrl, {
        headers: { 
          'Authorization': `token ${token}`,
          'User-Agent': 'Cloudflare-Worker'
        }
      });
      
      let sha = null;
      if (getResponse.ok) {
        const fileData = await getResponse.json();
        sha = fileData.sha;
        console.log('ğŸ“ Existing file SHA:', sha);
      } else {
        console.log('ğŸ“ File not found, will create new one');
      }
      
      // áƒá‹ Upload Body á€•á€¼á€„á€ºá€†á€„á€ºá€™á€šá€º
      const uploadBody = {
        message: commitMessage,
        content: base64Content,
        branch: branch
      };
      
      if (sha) {
        uploadBody.sha = sha;  // File á€¡á€Ÿá€±á€¬á€„á€ºá€¸á€›á€¾á€­á€›á€„á€º Update
      }
      
      // á„á‹ GitHub API á€€á€­á€¯ PUT Request á€•á€­á€¯á€·á€™á€šá€º
      const uploadUrl = `https://api.github.com/repos/${repo}/contents/${path}`;
      const uploadResponse = await fetch(uploadUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json',
          'User-Agent': 'Cloudflare-Worker'
        },
        body: JSON.stringify(uploadBody)
      });
      
      // á…á‹ Response á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€™á€šá€º
      const responseText = await uploadResponse.text();
      console.log('ğŸ“¦ GitHub Response:', uploadResponse.status, responseText);
      
      if (!uploadResponse.ok) {
        let errorMsg = `GitHub API Error (${uploadResponse.status})`;
        try {
          const error = JSON.parse(responseText);
          errorMsg = error.message || errorMsg;
        } catch (e) {
          // JSON parse error
        }
        return { success: false, error: errorMsg };
      }
      
      return { success: true };
      
    } catch (error) {
      console.error('ğŸ”¥ GitHub upload error:', error);
      return { success: false, error: error.message };
    }
  }
};